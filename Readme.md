# GATE-SERVICE  
  
**GATE-SERVICE** является микросервисом обмена данными между фронтендом и микросервисами [golos.io](https://golos.io).  
Также известен как фронтенд-гейт. Использует веб-сокеты с JSON-RPC для общения с клиентами.
Дополнительно осуществляет авторизацию пользователей.

### Основное

Микросервис пробрасывает данные между клиентами и микросервисами, используя роутинг по трем поинтам:

  - Идентификатор канала - определяется на этапе подключения пользователя.  
   Гарантирует что данные поступят конкретному получателю.
  - Имя пользователя - идентификатор пользователя, определяется автоматически.   
   Гарантирует что пользователю будут доступны только предназначенные ему данные.
  - Идентификатор запроса - определяется идентификатором JSON-RPC.    
   Гарантирует порядок и идентификацию ответов.  
   При этом на 1 запрос может быть множество ответов с одинаковым идентификатором (например для подписки на что-либо).

Данные внутри формируются в особом формате и переправляются дальше:

 ```
 {
    _frontendGate: true, // флаг формата фронтенд-гейта
    channelId: <id>,     // канал
    requestId: <id>,     // запрос
    user: <name>,        // имя пользователя
    params: <data>,      // оригинальные данные
 }
 ```

Пользователь обратно получает данные в обычном JSON-RPC формате - это может быть как ответ целевого сервиса, 
так и ответ с ошибкой на уровне гейта, в случае возникновения оной.

### Роутинг запросов клиента

Роутинг и валидация непосредственно параметров запросов производится на стороне FACADE-SERVICE, гейт занимается лишь переправкой входящих сообщений и более низкоуровневыми вещами.
Также гейт занимается непосредственно авторизацией, о чем детальнее описано ниже.

### Авторизация

При подключении сервер сам оповещает о необходимости авторизироваться через JSON-RPC нотификацию.
Также можно самостоятельно попросить авторизацию отправив запрос с методом `getSecret`.
Ответ содержит поле параметров, первым и единственным элементом является секретная строка, которую нужно подписать приватным
ключем, оформив объект в виде фейковой транзакции в виде:

 ```
 {
     ref_block_num: 3367,
     ref_block_prefix: 879276768,
     expiration: '2018-07-06T14:52:24',
     operations: [
         [
             'vote',
             {
                 voter: <user>,      // Имя пользователя
                 author: 'test',
                 permlink: <secret>, // Секрет, который пришел в запросе с сервера
                 weight: 1,
             },
         ],
     ],
     extensions: [],
 }
 ```

Для подписи можно использовать возможности библиотеки golos-js и осуществить подпись
вызовом `golos.auth.signTransaction(<fake>, [<private_key>])`.

Далее необходимо отправить на сервер запрос с JSON-RPC методом `auth` и двумя параметрами - `user` и `sign`.
Первый должен содержать имя пользователя, а второй - сгенерированную подпись.  
В случае успеха текущее подключение будет закреплено за указанным пользователем.

*При этом приватный ключ не передается по сети, обеспечивая безопасность авторизации.*
 
### Переменные окружения

Возможные переменные окружения `ENV`:

  - `GLS_FACADE_CONNECT` *(обязательно)* - адрес подключения к микросервису фасаду.
 
  - `GLS_FRONTEND_GATE_HOST` *(обязательно)* - адрес, который будет использован для входящих веб-сокет подключений клиентов.    
   Дефолтное значение при запуске без докера - `0.0.0.0`
 
  - `GLS_FRONTEND_GATE_PORT` *(обязательно)* - адрес порта, который будет использован для входящих веб-сокет подключений клиентов.    
   Дефолтное значение при запуске без докера - `8080`, пересекается с `GLS_GATE_PORT`
    
  - `GLS_CONNECTOR_HOST` *(обязательно)* - адрес, который будет использован для входящих подключений связи микросервисов.  
   Дефолтное значение при запуске без докера - `0.0.0.0`
    
  - `GLS_CONNECTOR_PORT` *(обязательно)* - адрес порта, который будет использован для входящих подключений связи микросервисов.  
   Дефолтное значение при запуске без докера - `8080`, пересекается с `GLS_FRONTEND_GATE_PORT`
    
  - `GLS_METRICS_HOST` *(обязательно)* - адрес хоста для метрик StatsD.  
   Дефолтное значение при запуске без докера - `127.0.0.1`
          
  - `GLS_METRICS_PORT` *(обязательно)* - адрес порта для метрик StatsD.  
   Дефолтное значение при запуске без докера - `8125`
    
  - `GLS_MONGO_CONNECT` - строка подключения к базе MongoDB.  
   Дефолтное значение - `mongodb://mongo/admin`
    
  - `GLS_DAY_START` - время начала нового дня в часах относительно UTC.
   Дефолтное значение - `3` (день начинается в 00:00 по Москве).
   
  - `GLS_FRONTEND_GATE_TIMEOUT_FOR_CLIENT` - время, через которе клиент, подключенный по веб-сокету, будет отключен если он не отвечает на пинг запросы или от него не приходят новые входящие запросы.  
   Дефолтное значение - `60000` (1 минута)  
  
### Запуск

Для запуска достаточно вызвать команду `docker-compose up` в корне проекта, предварительно указав необходимые `ENV` переменные.    
